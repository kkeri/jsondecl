{"version":3,"sources":["../src/compiler.js"],"names":["compile","str","opts","module","error","cc","CompilerContext","importPath","filename","buildBlock","errors","bind","exports","envStack","currentBlock","undefined","block","push","pop","id","decl","decls","body","expr","exported","defaultExport","node","method","constructor","name","call","msg","Module","enter","importList","import_","declList","leave","Import","modulePath","moduleSpec","donor","require","e","code","message","item","originalId","declare","localId","compileImportExpression","Const","LogicalOr","items","forEach","i","LogicalAnd","ChainedCall","calls","Call","args","func","lookup","Object_","properties","Array_","Property","value"],"mappings":"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","file":"compiler.js","sourcesContent":["import { parse } from './parser'\nimport { dirname, join } from 'path'\n\nexport function compile (str, opts = {}) {\n  const module = parse(str, {\n    error: opts.error\n  })\n  if (!module) return null\n  const cc = new CompilerContext(module, {\n    error: opts.error || function () {},\n    importPath: dirname(opts.filename)\n  })\n  cc.buildBlock(module)\n  if (cc.errors) return null\n  cc.bind(module)\n  if (cc.errors) return null\n  if (!cc.exports) {\n    cc.error(`the module should export at least one declaration`)\n    return null\n  }\n  return module\n}\n\nclass CompilerContext {\n  constructor (module, opts) {\n    this.module = module\n    this.opts = opts\n    this.errors = 0\n    this.exports = 0\n    this.envStack = []\n    this.currentBlock = undefined\n  }\n\n  enter (block) {\n    this.envStack.push(this.currentBlock)\n    this.currentBlock = block\n  }\n\n  leave () {\n    this.currentBlock = this.envStack.pop()\n  }\n\n  lookup (id) {\n    let decl = this.currentBlock.decls[id]\n    if (decl) {\n      return decl.body\n    } else {\n      this.error(`${id}: undeclared identifier`)\n    }\n  }\n\n  declare (id, expr, exported) {\n    if (!id) {\n      if (this.module.defaultExport) {\n        this.error(`duplicate default export`)\n      } else {\n        this.module.defaultExport = expr\n        this.exports++\n      }\n    } else if (id in this.currentBlock.decls) {\n      this.error(`${id}: duplicate identifier`)\n    } else {\n      this.currentBlock.decls[id] = expr\n      if (exported) {\n        this.module.exports[id] = expr\n        this.exports++\n      }\n    }\n  }\n\n  buildBlock (node) {\n    let method = buildBlock[node.constructor.name]\n    if (method) method.call(node, this)\n  }\n\n  bind (node) {\n    let method = bind[node.constructor.name]\n    if (method) method.call(node, this)\n  }\n\n  compileImportExpression (expr) {\n    // todo: check type of import and handle accordingly\n    return expr\n  }\n\n  error (msg) {\n    this.errors++\n    this.opts.error(msg)\n  }\n}\n\nconst buildBlock = {\n\n  Module (cc) {\n    cc.enter(this)\n    for (let import_ of this.importList) {\n      cc.buildBlock(import_)\n    }\n    for (let decl of this.declList) {\n      cc.buildBlock(decl)\n    }\n    cc.leave()\n  },\n\n  Import (cc) {\n    if (!cc.opts.importPath) {\n      cc.error(`using import requires the 'importPath' option`)\n      return\n    }\n    const modulePath = join(cc.opts.importPath, this.moduleSpec)\n    let donor\n    try {\n      donor = require(modulePath)\n    } catch (e) {\n      if (e.code === 'MODULE_NOT_FOUND') {\n        cc.error(e.message)\n        return\n      }\n    }\n    for (let item of this.importList) {\n      if (item.originalId in donor) {\n        cc.declare(item.localId,\n          cc.compileImportExpression(donor[item.originalId]))\n      } else {\n        cc.error(`${item.originalId}: identifier not defined in module ` +\n          `'${this.moduleSpec}'`)\n      }\n    }\n  },\n\n  Const (cc) {\n    cc.declare(this.id, this, this.exported)\n    cc.buildBlock(this.body)\n  },\n\n  LogicalOr (cc) {\n    this.items.forEach(i => cc.buildBlock(i))\n  },\n\n  LogicalAnd (cc) {\n    this.items.forEach(i => cc.buildBlock(i))\n  },\n\n  ChainedCall (cc) {\n    this.calls.forEach(i => cc.buildBlock(i))\n  },\n\n  Call (cc) {\n    this.args.forEach(i => cc.buildBlock(i))\n  }\n}\n\nconst bind = {\n\n  Module (cc) {\n    cc.enter(this)\n    for (let decl of this.declList) {\n      cc.bind(decl)\n    }\n    cc.leave()\n  },\n\n  Const (cc) {\n    cc.bind(this.body)\n    return this\n  },\n\n  LogicalOr (cc) {\n    this.items.forEach(i => cc.bind(i))\n  },\n\n  LogicalAnd (cc) {\n    this.items.forEach(i => cc.bind(i))\n  },\n\n  ChainedCall (cc) {\n    this.calls.forEach(i => cc.bind(i))\n  },\n\n  Call (cc) {\n    this.func = cc.lookup(this.id)\n    this.args.forEach(i => cc.bind(i))\n  },\n\n  Object_ (cc) {\n    this.properties.forEach(i => cc.bind(i))\n  },\n\n  Array_ (cc) {\n    this.items.forEach(i => cc.bind(i))\n  },\n\n  Property (cc) {\n    cc.bind(this.name)\n    cc.bind(this.value)\n  }\n}\n"]}